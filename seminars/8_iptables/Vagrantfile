required_plugins = %w(vagrant-vbguest)

plugins_to_install = required_plugins.select { |plugin| not Vagrant.has_plugin? plugin }
if not plugins_to_install.empty?
  puts "Installing plugins: #{plugins_to_install.join(' ')}"
  if system "vagrant plugin install #{plugins_to_install.join(' ')}"
    exec "vagrant #{ARGV.join(' ')}"
  else
    abort "Installation of one or more plugins has failed. Aborting."
  end
end

Vagrant.configure("2") do |config|
  # Define the Ubuntu box to use
  config.vm.box = "ubuntu/focal64"

  # VM A Configuration
  config.vm.define "A" do |a|
    a.vm.hostname = "vmA"

    # SSH Access Interface
    a.vm.network "forwarded_port", guest: 22, host: 22001, auto_correct: false

    # Interface connecting A and B (L2 network net_ab)
    a.vm.network "private_network",
                 ip: "172.1.2.1",
                 virtualbox__intnet: "net_ab",
                 auto_config: true

    # Add route to reach C via B
    a.vm.provision "shell", inline: <<-SHELL
      sudo ip route add 172.2.3.0/24 via 172.1.2.2
    SHELL
  end

  # VM B Configuration
  config.vm.define "B" do |b|
    b.vm.hostname = "vmB"

    # SSH Access Interface
    b.vm.network "forwarded_port", guest: 22, host: 22002, auto_correct: false

    # Interface connecting A and B (L2 network net_ab)
    b.vm.network "private_network",
                 ip: "172.1.2.2",
                 virtualbox__intnet: "net_ab",
                 auto_config: true

    # Interface connecting B and C (L2 network net_bc)
    b.vm.network "private_network",
                 ip: "172.2.3.2",
                 virtualbox__intnet: "net_bc",
                 auto_config: true

    # Enable IPv4 forwarding
    b.vm.provision "shell", inline: <<-SHELL
      sudo sysctl -w net.ipv4.ip_forward=1
      sudo sed -i '/^#*net.ipv4.ip_forward=/c\\net.ipv4.ip_forward=1' /etc/sysctl.conf
    SHELL
  end

  # VM C Configuration
  config.vm.define "C" do |c|
    c.vm.hostname = "vmC"

    # SSH Access Interface
    c.vm.network "forwarded_port", guest: 22, host: 22003, auto_correct: false

    # Interface connecting B and C (L2 network net_bc)
    c.vm.network "private_network",
                 ip: "172.2.3.3",
                 virtualbox__intnet: "net_bc",
                 auto_config: true

    # Add route to reach A via B
    c.vm.provision "shell", inline: <<-SHELL
      sudo ip route add 172.1.2.0/24 via 172.2.3.2
    SHELL
  end
end
